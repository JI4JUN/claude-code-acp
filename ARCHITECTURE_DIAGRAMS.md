# claude-code-acp æ¶æ„å¯è§†åŒ–æŒ‡å—

## å…¨å±€æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ACP å®¢æˆ·ç«¯                               â”‚
â”‚          (Zed / Emacs / Neovim / marimo)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ NDJSON åè®®
                           â”‚ (initialize, newSession, prompt, ...)
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚               claude-code-acp æœåŠ¡å™¨                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ClaudeAcpAgent (main)                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ sessions[sessionId] â†’ Session                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ toolUseCache â†’ å·¥å…·è°ƒç”¨è·Ÿè¸ª                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ fileContentCache â†’ æ–‡ä»¶ç¼“å­˜                    â”‚   â”‚
â”‚  â”‚  â””â”€ backgroundTerminals â†’ åå°è¿›ç¨‹                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚                           â”‚                      â”‚
â”‚          â”‚ initialize()               â”‚ newSession()        â”‚
â”‚          â”‚ prompt()                   â”‚ setSessionMode()    â”‚
â”‚          â”‚ cancel()                   â”‚ readTextFile()      â”‚
â”‚          â”‚ setSessionModel()          â”‚ writeTextFile()     â”‚
â”‚          â”‚                            â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         MCP æœåŠ¡å™¨ï¼ˆæä¾›å·¥å…·ç»™ SDKï¼‰                â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  Main MCP Server (SDK ç›´æ¥å®ä¾‹åŒ–)                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Read      (mcp__acp__Read)                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Write     (mcp__acp__Write)                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ Edit      (mcp__acp__Edit)                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ Bash      (mcp__acp__Bash)                      â”‚   â”‚
â”‚  â”‚  â”œâ”€ BashOutput(mcp__acp__BashOutput)               â”‚   â”‚
â”‚  â”‚  â””â”€ KillShell (mcp__acp__KillShell)                 â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  Permission HTTP Server (æƒé™æ£€æŸ¥)                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ ç›‘å¬åŠ¨æ€ç«¯å£                                   â”‚   â”‚
â”‚  â”‚  â””â”€ ä»£ç†æƒé™è¯·æ±‚                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ SDK Query å¯¹è±¡
                           â”‚ (æ¥è‡ª @anthropic-ai/claude-agent-sdk)
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Claude Code SDK                          â”‚
â”‚  â”œâ”€ Query å¯¹è±¡ (è¿­ä»£å¼æ¶ˆæ¯æµ)                              â”‚
â”‚  â”œâ”€ Model ç®¡ç† (åˆ‡æ¢æ¨¡å‹)                                   â”‚
â”‚  â”œâ”€ Permission ç®¡ç†                                          â”‚
â”‚  â””â”€ å‘½ä»¤æ”¯æŒ (slash commands)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Claude API è°ƒç”¨
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Anthropic API                          â”‚
â”‚             (Claude æ¨¡å‹æ¨ç†æœåŠ¡)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
æ—¶é—´è½´ â†’

å®¢æˆ·ç«¯                                  æœåŠ¡å™¨
â”‚                                        â”‚
â”œâ”€ initialize() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚
â”‚                                   ClaudeAcpAgent.initialize()
â”‚                                   è¿”å›èƒ½åŠ›å£°æ˜
â”‚  â†â”€ initialize response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¤
â”‚                                        â”‚
â”œâ”€ newSession() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
â”‚                                   ClaudeAcpAgent.newSession()
â”‚                                   â”œâ”€ ç”Ÿæˆ sessionId
â”‚                                   â”œâ”€ åˆ›å»º Query å¯¹è±¡
â”‚                                   â”œâ”€ å¯åŠ¨ MCP æœåŠ¡å™¨
â”‚                                   â”œâ”€ è·å–å¯ç”¨å‘½ä»¤/æ¨¡å‹
â”‚  â†â”€ newSession response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¤
â”‚   (sessionId, models, modes)           â”‚
â”‚                                        â”‚
â”œâ”€ prompt(text, sessionId) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚
â”‚                                   ClaudeAcpAgent.prompt()
â”‚                                   â”œâ”€ è½¬æ¢ä¸º SDK æ ¼å¼
â”‚                                   â”œâ”€ query.next() å¼€å§‹è¿­ä»£
â”‚                                   â”‚
â”‚  â†â”€ sessionUpdate(tool_call) â”€â”€â”€â”€â”€â”€ â”¤ (å®æ—¶å¤šæ¬¡)
â”‚                                   â”œâ”€ å·¥å…·è°ƒç”¨é€šçŸ¥
â”‚  â†â”€ sessionUpdate(text_chunk) â”€â”€â”€â”€â”€â”€ â”¤
â”‚                                   â”œâ”€ æ–‡æœ¬æµé€šçŸ¥
â”‚  â†â”€ sessionUpdate(...) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¤
â”‚                                   â”‚
â”‚  â†â”€ prompt response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¤
â”‚   (stopReason: "end_turn")          â”‚
â”‚                                        â”‚
â”œâ”€ setSessionMode(modeId) â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’    â”‚
â”‚                                   æ”¹å˜æƒé™æ¨¡å¼
â”‚  â†â”€ ok â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”¤
â”‚                                        â”‚
â”œâ”€ prompt(new text) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’     â”‚
â”‚                                   ç»§ç»­å¯¹è¯...
â”‚                                        â”‚
â””â”€ [å…³é—­è¿æ¥] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
                                    ä¼šè¯ç»“æŸ
```

---

## Prompt å¤„ç†æµç¨‹è¯¦è§£

```
ACP PromptRequest åˆ°è¾¾
â”‚
â”œâ”€ {
â”‚    sessionId: "xxx",
â”‚    prompt: [
â”‚      { type: "text", text: "..." },
â”‚      { type: "image", data: "...", mimeType: "..." },
â”‚      { type: "resource_link", uri: "file://..." }
â”‚    ]
â”‚  }
â”‚
â””â”€â†’ promptToClaude() è½¬æ¢
    â”‚
    â”œâ”€ text å—
    â”‚  â””â”€ { type: "text", text: "..." }
    â”‚
    â”œâ”€ image å— (ä¸¤ç§æ ¼å¼)
    â”‚  â”œâ”€ å¦‚æœæœ‰ data â†’ { type: "image", source: { type: "base64", ... } }
    â”‚  â””â”€ å¦‚æœæœ‰ http url â†’ { type: "image", source: { type: "url", ... } }
    â”‚
    â”œâ”€ resource å—
    â”‚  â””â”€ { type: "text", text: "@[resource_name](uri)\n<context>content</context>" }
    â”‚
    â””â”€ è¿”å› SDKUserMessage
        {
          type: "user",
          message: {
            role: "user",
            content: [è½¬æ¢åçš„å—æ•°ç»„]
          },
          session_id: sessionId,
          parent_tool_use_id: null
        }
       â”‚
       â””â”€â†’ input.push(message)
           â”‚
           â””â”€â†’ Query è¿­ä»£æ¶ˆè´¹
               â”‚
               â””â”€â†’ Claude å¤„ç†å¹¶è¿”å›
```

---

## Query è¿­ä»£å¾ªç¯è¯¦è§£

```
input.push(userMessage)  // ç”¨æˆ·æ¶ˆæ¯å…¥é˜Ÿ
â”‚
â””â”€â†’ while (true) {
      const { value: message, done } = await query.next()

      if (done) break;  // ä¼šè¯ç»“æŸ

      switch (message.type) {

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ SYSTEM æ¶ˆæ¯ (åˆå§‹åŒ–/ç»´æŠ¤)                          â”‚
      â”‚ message.subtype:                                    â”‚
      â”‚ â”œâ”€ "init"             â†’ åˆå§‹åŒ–ï¼Œæ— éœ€å¤„ç†           â”‚
      â”‚ â”œâ”€ "compact_boundary" â†’ ä¸Šä¸‹æ–‡å‹ç¼©è¾¹ç•Œ             â”‚
      â”‚ â””â”€ "hook_response"    â†’ é’©å­å“åº” (éƒ¨åˆ†å®ç°)       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ RESULT æ¶ˆæ¯ (å¯¹è¯ç»“æŸ)                             â”‚
      â”‚ message.subtype:                                    â”‚
      â”‚ â”œâ”€ "success"              â†’ è¿”å› stopReason        â”‚
      â”‚ â”œâ”€ "error_during_execution" â†’ è¿”å›é”™è¯¯            â”‚
      â”‚ â”œâ”€ "error_max_turns"      â†’ è¶…è¿‡æœ€å¤§è½®æ•°           â”‚
      â”‚ â””â”€ ... (å…¶ä»–é”™è¯¯)          â†’ è¿”å›æ‹’ç»               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ STREAM_EVENT æ¶ˆæ¯ (å®æ—¶æµ)                         â”‚
      â”‚ event.type:                                         â”‚
      â”‚ â”œâ”€ "content_block_start"  â†’ å—å¼€å§‹                 â”‚
      â”‚ â”œâ”€ "content_block_delta"  â†’ å—æ•°æ®å¢é‡             â”‚
      â”‚ â”œâ”€ "message_start"        â†’ æ¶ˆæ¯å¼€å§‹               â”‚
      â”‚ â”œâ”€ "message_delta"        â†’ æ¶ˆæ¯å¢é‡               â”‚
      â”‚ â”œâ”€ "message_stop"         â†’ æ¶ˆæ¯ç»“æŸ               â”‚
      â”‚ â””â”€ "content_block_stop"   â†’ å—ç»“æŸ                 â”‚
      â”‚                                                     â”‚
      â”‚ â””â”€â†’ streamEventToAcpNotifications()                â”‚
      â”‚     â””â”€ è½¬æ¢ä¸º ACP é€šçŸ¥æµ                          â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ USER/ASSISTANT æ¶ˆæ¯ (å†…å®¹)                        â”‚
      â”‚                                                     â”‚
      â”‚ content å—ç±»å‹:                                    â”‚
      â”‚ â”œâ”€ "text" / "text_delta"                           â”‚
      â”‚ â”‚  â””â”€ â†’ agent_message_chunk (æ–‡æœ¬)               â”‚
      â”‚ â”œâ”€ "image"                                         â”‚
      â”‚ â”‚  â””â”€ â†’ agent_message_chunk (å›¾ç‰‡)               â”‚
      â”‚ â”œâ”€ "thinking" / "thinking_delta"                   â”‚
      â”‚ â”‚  â””â”€ â†’ agent_thought_chunk (æ€è€ƒ)               â”‚
      â”‚ â”œâ”€ "tool_use"                                      â”‚
      â”‚ â”‚  â””â”€ â†’ tool_call (å·¥å…·è°ƒç”¨)                      â”‚
      â”‚ â”‚      â”œâ”€ ç¼“å­˜ï¼štoolUseCache[id] = toolUse      â”‚
      â”‚ â”‚      â””â”€ è½¬æ¢ï¼štoolInfoFromToolUse()             â”‚
      â”‚ â”œâ”€ "tool_result"                                   â”‚
      â”‚ â”‚  â””â”€ â†’ tool_call_update (å·¥å…·ç»“æœ)              â”‚
      â”‚ â”‚      â”œâ”€ æŸ¥è¯¢ï¼štoolUseCache[tool_use_id]        â”‚
      â”‚ â”‚      â””â”€ è½¬æ¢ï¼štoolUpdateFromToolResult()        â”‚
      â”‚ â””â”€ ... (å…¶ä»–å—ç±»å‹å¿½ç•¥)
      â”‚
      â”‚ è½¬æ¢è¿‡ç¨‹:
      â”‚   SDK ContentBlock â†’ ACP SessionNotification
      â”‚                  â”‚
      â”‚                  â”œâ”€ å†…å®¹æå–
      â”‚                  â”œâ”€ å…ƒæ•°æ®è£…é¥° (title, kind, locations)
      â”‚                  â””â”€ æ‰“åŒ…ä¸º ACP æ ¼å¼
      â”‚
      â”‚ å‘é€:
      â”‚   await this.client.sessionUpdate(notification)
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    }
```

---

## å·¥å…·è°ƒç”¨å’Œç»“æœå¤„ç†

```
Claude å†³å®šä½¿ç”¨å·¥å…·
â”‚
â”œâ”€ SDK è¿”å› tool_use å—:
â”‚  {
â”‚    type: "tool_use",
â”‚    id: "toolu_01234567890",
â”‚    name: "mcp__acp__Read",
â”‚    input: { file_path: "/path/to/file.ts", offset: 1, limit: 100 }
â”‚  }
â”‚
â””â”€â†’ toAcpNotifications() å¤„ç†
    â”‚
    â”œâ”€ æ­¥éª¤ 1: ä¿å­˜åˆ°ç¼“å­˜
    â”‚  toolUseCache["toolu_01234567890"] = {
    â”‚    type: "mcp_tool_use",
    â”‚    id: "toolu_01234567890",
    â”‚    name: "mcp__acp__Read",
    â”‚    input: { file_path: "...", ... }
    â”‚  }
    â”‚
    â”œâ”€ æ­¥éª¤ 2: è½¬æ¢å·¥å…·ä¿¡æ¯
    â”‚  toolInfoFromToolUse(toolUse) â†’ {
    â”‚    title: "Read /path/to/file.ts (1-100)",
    â”‚    kind: "read",
    â”‚    content: [],
    â”‚    locations: [{ path: "/path/to/file.ts", line: 0 }]
    â”‚  }
    â”‚
    â”œâ”€ æ­¥éª¤ 3: ç”Ÿæˆ ACP é€šçŸ¥
    â”‚  {
    â”‚    sessionId: "sess_xxx",
    â”‚    update: {
    â”‚      sessionUpdate: "tool_call",
    â”‚      toolCallId: "toolu_01234567890",
    â”‚      title: "Read /path/to/file.ts (1-100)",
    â”‚      kind: "read",
    â”‚      rawInput: { file_path: "...", offset: 1, limit: 100 },
    â”‚      locations: [{ path: "...", line: 0 }],
    â”‚      status: "pending"
    â”‚    }
    â”‚  }
    â”‚
    â””â”€â†’ await this.client.sessionUpdate(notification)
        â”‚
        â””â”€â†’ å®¢æˆ·ç«¯æ˜¾ç¤ºå·¥å…·è°ƒç”¨UI
            â”‚
            â”œâ”€ æ˜¾ç¤ºæ ‡é¢˜å’Œä½ç½®
            â”œâ”€ [å¯é€‰] å®¡æŸ¥/æ‰¹å‡†
            â””â”€ [å¯é€‰] æŸ¥çœ‹åŸå§‹è¾“å…¥


å½“å·¥å…·æ‰§è¡Œå®Œæ¯•
â”‚
â”œâ”€ MCP å·¥å…·å¤„ç†å™¨è¿”å›ç»“æœ:
â”‚  {
â”‚    content: [
â”‚      { type: "text", text: "file contents..." }
â”‚    ]
â”‚  }
â”‚
â”œâ”€ SDK ç”Ÿæˆ tool_result å—:
â”‚  {
â”‚    type: "tool_result",
â”‚    tool_use_id: "toolu_01234567890",
â”‚    content: "file contents..."
â”‚  }
â”‚
â””â”€â†’ toAcpNotifications() å¤„ç†
    â”‚
    â”œâ”€ æ­¥éª¤ 1: æŸ¥è¯¢åŸå§‹å·¥å…·ä¿¡æ¯
    â”‚  toolUse = toolUseCache["toolu_01234567890"]
    â”‚
    â”œâ”€ æ­¥éª¤ 2: è½¬æ¢ç»“æœ
    â”‚  toolUpdateFromToolResult(result, toolUse) â†’ {
    â”‚    content: [{
    â”‚      type: "content",
    â”‚      content: { type: "text", text: "file contents..." }
    â”‚    }],
    â”‚    locations: [...]  // å¯èƒ½åŒ…å«æ–°çš„ä½ç½®ä¿¡æ¯
    â”‚  }
    â”‚
    â”œâ”€ æ­¥éª¤ 3: ç”Ÿæˆæ›´æ–°é€šçŸ¥
    â”‚  {
    â”‚    sessionId: "sess_xxx",
    â”‚    update: {
    â”‚      sessionUpdate: "tool_call_update",
    â”‚      toolCallId: "toolu_01234567890",
    â”‚      status: "completed",  // æˆ– "failed"
    â”‚      content: [...]
    â”‚    }
    â”‚  }
    â”‚
    â””â”€â†’ await this.client.sessionUpdate(notification)
        â”‚
        â””â”€â†’ å®¢æˆ·ç«¯æ›´æ–° UIï¼Œæ˜¾ç¤ºç»“æœ
```

---

## æƒé™ç³»ç»ŸçŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æƒé™æ¨¡å¼åˆ‡æ¢                                 â”‚
â”‚                                                               â”‚
â”‚  é»˜è®¤æ¨¡å¼: "default"                                          â”‚
â”‚                                                               â”‚
â”‚  available modes:                                             â”‚
â”‚  â”œâ”€ "default"          (æ€»æ˜¯è¯¢é—®)                            â”‚
â”‚  â”œâ”€ "acceptEdits"      (è‡ªåŠ¨æ¥å—ç¼–è¾‘)                        â”‚
â”‚  â”œâ”€ "plan"             (åªè¯»)                                â”‚
â”‚  â””â”€ "bypassPermissions" (è·³è¿‡æ‰€æœ‰ - ä»…é root)               â”‚
â”‚                                                               â”‚
â”‚  setSessionMode(modeId)                                       â”‚
â”‚  â””â”€ æ›´æ–° sessions[sessionId].permissionMode                 â”‚
â”‚     â””â”€ è°ƒç”¨ query.setPermissionMode(modeId)                 â”‚
â”‚        â””â”€ SDK åº”ç”¨æƒé™æ¨¡å¼                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å·¥å…·æ‰§è¡Œæµç¨‹:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¥å…·è¢« SDK è°ƒç”¨        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚
    â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒé™æ¨¡å¼ â”‚      â”‚ SDK æƒé™   â”‚
â”‚ = plan   â”‚      â”‚ ç³»ç»Ÿå¤„ç†   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚
     â”‚                 â”‚
   æ‹’ç»              â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“                â”‚                   â”‚
è¿”å›é”™è¯¯        permissionMode:          â”‚
                â”œâ”€ default              â”‚
                â”‚  â””â”€ æ˜¾ç¤ºæƒé™æç¤º      â”‚
                â”‚     â”œâ”€ ç”¨æˆ·æ‰¹å‡†       â”‚
                â”‚     â”‚  â””â”€ æ‰§è¡Œ        â”‚
                â”‚     â””â”€ ç”¨æˆ·æ‹’ç»       â”‚
                â”‚        â””â”€ è¿”å›é”™è¯¯    â”‚
                â”‚                       â”‚
                â”œâ”€ acceptEdits          â”‚
                â”‚  â”œâ”€ å·¥å…·åç§° âˆˆ ç¼–è¾‘   â”‚
                â”‚  â”‚  â””â”€ è‡ªåŠ¨æ‰§è¡Œ       â”‚
                â”‚  â””â”€ å·¥å…·åç§° âˆ‰ ç¼–è¾‘   â”‚
                â”‚     â””â”€ æ˜¾ç¤ºæç¤º       â”‚
                â”‚                       â”‚
                â”œâ”€ bypassPermissions    â”‚
                â”‚  â””â”€ ç›´æ¥æ‰§è¡Œ           â”‚
                â”‚                       â”‚
                â””â”€ plan                 â”‚
                   â””â”€ æ‹’ç»              â”‚
                      (åªè¯»)            â”‚

root ç”¨æˆ·å¤„ç†:

    if (process.geteuid() === 0) {
      // IS_ROOT = true
      allowDangerouslySkipPermissions = false
      // bypassPermissions é€‰é¡¹ä¸å¯ç”¨
    }
```

---

## æ–‡ä»¶æ“ä½œç¼“å­˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              fileContentCache                                â”‚
â”‚            { [filePath]: content }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ“ä½œ 1: Read (with offset & limit)
â”‚
â”œâ”€ agent.readTextFile({ path, line, limit })
â”œâ”€ extractLinesWithByteLimit(content, 50KB)
â””â”€ ä¸æ›´æ–°ç¼“å­˜ (éƒ¨åˆ†è¯»å–)

æ“ä½œ 2: Read (complete)
â”‚
â”œâ”€ agent.readTextFile({ path })
â”‚  (ä¸å¸¦ limit)
â””â”€ fileContentCache[path] = content (å®Œæ•´ç¼“å­˜)

æ“ä½œ 3: Edit
â”‚
â”œâ”€ æŸ¥è¯¢ç¼“å­˜: cachedFileContent[path]
â”œâ”€ æ‰§è¡Œæ›¿æ¢: replaceAndCalculateLocation(old, new)
â”‚  â”œâ”€ éªŒè¯ old_string å­˜åœ¨ä¸”å”¯ä¸€
â”‚  â”œâ”€ è®¡ç®—å—å½±å“è¡Œå·
â”‚  â””â”€ è¿”å› { newContent, lineNumbers }
â”œâ”€ å†™å…¥æ–‡ä»¶: agent.writeTextFile({ path, content: newContent })
â””â”€ æ›´æ–°ç¼“å­˜: fileContentCache[path] = newContent

æ“ä½œ 4: Write
â”‚
â”œâ”€ agent.writeTextFile({ path, content })
â””â”€ fileContentCache[path] = content (åŒæ­¥æ›´æ–°)

ç¼“å­˜ä¸€è‡´æ€§:
â”‚
â”œâ”€ å†™æ“ä½œåç«‹å³æ›´æ–° âœ“
â”œâ”€ ç¼–è¾‘æ“ä½œè‡ªåŠ¨åŒæ­¥ âœ“
â””â”€ å…¶ä»–å®¢æˆ·ç«¯ç¼–è¾‘ ? å¯èƒ½ä¸åŒæ­¥
   (ä»… ACP ä¼šè¯å†…éƒ¨ä¸€è‡´)
```

---

## MCP æœåŠ¡å™¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCP æœåŠ¡å™¨é…ç½®                               â”‚
â”‚        (åœ¨ newSession() ä¸­åˆ›å»º)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚
        â–¼                        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Main MCP    â”‚        â”‚ Permission MCP  â”‚
  â”‚  Server      â”‚        â”‚ Server (HTTP)   â”‚
  â”‚              â”‚        â”‚                 â”‚
  â”‚ å®ä¾‹åŒ–åœ¨     â”‚        â”‚ åŠ¨æ€ç«¯å£        â”‚
  â”‚ å†…å­˜ä¸­       â”‚        â”‚ 127.0.0.1:xxxx  â”‚
  â”‚              â”‚        â”‚                 â”‚
  â”‚ å·¥å…·åˆ—è¡¨:    â”‚        â”‚ æƒé™æ£€æŸ¥        â”‚
  â”‚ â”œâ”€ Read      â”‚        â”‚ â”œâ”€ æ ¡éªŒä¼šè¯ID  â”‚
  â”‚ â”œâ”€ Write     â”‚        â”‚ â””â”€ å§”æ‰˜æƒé™     â”‚
  â”‚ â”œâ”€ Edit      â”‚        â”‚   å†³ç­–ç»™ SDK    â”‚
  â”‚ â”œâ”€ Bash      â”‚        â”‚                 â”‚
  â”‚ â”œâ”€ Kill      â”‚        â”‚ ç›®çš„:           â”‚
  â”‚ â””â”€ BashOut   â”‚        â”‚ æ‹¦æˆªæƒé™è¯·æ±‚  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ å¹¶æä¾› UI åé¦ˆ  â”‚
        â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚
              â–¼              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ SDK Query   â”‚   â”‚ ACP ä»£ç† â”‚
      â”‚ ä½¿ç”¨å·¥å…·    â”‚   â”‚ å§”æ‰˜è°ƒç”¨ â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æµå¼å“åº”æ¶æ„

```
åŒ…å«éƒ¨åˆ†æ¶ˆæ¯æµ:

options {
  includePartialMessages: true
}

  â†“

SDK è¿­ä»£:

  message 1: {
    type: "stream_event",
    event: {
      type: "content_block_start",
      content_block: { type: "text", text: "" }
    }
  }

  message 2: {
    type: "stream_event",
    event: {
      type: "content_block_delta",
      delta: { type: "text_delta", text: "Hello" }
    }
  }

  message 3: {
    type: "stream_event",
    event: {
      type: "content_block_delta",
      delta: { type: "text_delta", text: " world" }
    }
  }

  message 4: {
    type: "stream_event",
    event: {
      type: "content_block_stop"
    }
  }

  message 5: {
    type: "stream_event",
    event: {
      type: "message_stop"
    }
  }

  â†“

streamEventToAcpNotifications() å¤„ç†:

  notification 1: {
    sessionUpdate: "agent_message_chunk",
    content: { type: "text", text: "" }
  }

  notification 2: {
    sessionUpdate: "agent_message_chunk",
    content: { type: "text", text: "Hello" }
  }

  notification 3: {
    sessionUpdate: "agent_message_chunk",
    content: { type: "text", text: " world" }
  }

  â†“

å®¢æˆ·ç«¯å®æ—¶æ¸²æŸ“:
  "Hello world" (é€å­—æ˜¾ç¤º)
```

---

## åå°ç»ˆç«¯ç®¡ç†

```
åå°æ‰§è¡Œè¯·æ±‚:

Bash å·¥å…·è¾“å…¥:
â”œâ”€ command: "npm install"
â”œâ”€ timeout: 120000
â””â”€ run_in_background: true

  â†“

å¤„ç†æµç¨‹:

1. åˆ›å»ºç»ˆç«¯
   handle = await client.createTerminal({
     command, sessionId, outputByteLimit: 32000
   })

2. æ³¨å†Œåå°ç»ˆç«¯
   backgroundTerminals[handle.id] = {
     handle,
     status: "started",
     lastOutput: null
   }

3. æ›´æ–°å®¢æˆ·ç«¯
   sessionUpdate({
     sessionUpdate: "tool_call_update",
     toolCallId,
     status: "in_progress",
     content: [{ type: "terminal", terminalId: handle.id }]
   })

4. ç«é€Ÿç›‘æ§
   Promise.race([
     handle.waitForExit()     // æ­£å¸¸å®Œæˆ
       â†’ status: "exited"
       â†’ exitStatus: number

     abortPromise              // ç”¨æˆ·å–æ¶ˆ
       â†’ status: "aborted"
       â†’ exitStatus: null

     sleep(timeout)            // è¶…æ—¶
       â†’ status: "timedOut"
       â†’ exitStatus: null
   ])

5. çŠ¶æ€è½¬æ¢
   backgroundTerminals[handle.id] = {
     status: "exited"|"aborted"|"timedOut",
     pendingOutput: TerminalOutputResponse
   }

6. BashOutput æŸ¥è¯¢
   if (run_in_background) {
     return outputCache[shellId]
   }

7. KillShell ä¸­æ­¢
   if (backgroundTerminals[shellId].status === "started") {
     await handle.kill()
   }
```

---

## åŒ…è£…å®Œæ•´çš„ä¼šè¯ç¤ºä¾‹

```
æ—¶é—´æµ: ç”¨æˆ·åœ¨ Zed ä¸­å‘èµ· Claude Code è¯·æ±‚

T0:
  Zed å¯åŠ¨ claude-code-acp è¿›ç¨‹
  â””â”€ index.ts â†’ runAcp() â†’ listen on stdin/stdout

T1:
  Zed å‘é€: initialize()
  acp-agent: initialize()
  â””â”€ è¿”å›èƒ½åŠ›å£°æ˜ (å›¾ç‰‡, åµŒå…¥ä¸Šä¸‹æ–‡, MCP/HTTP)

T2:
  Zed å‘é€: newSession()
  acp-agent: newSession()
  â”œâ”€ sessionId = uuid v7
  â”œâ”€ åˆ›å»º Query å¯¹è±¡
  â”œâ”€ å¯åŠ¨ MCP å·¥å…·æœåŠ¡
  â”œâ”€ å¯åŠ¨æƒé™ HTTP æœåŠ¡
  â”œâ”€ è·å–å¯ç”¨æ¨¡å‹
  â”œâ”€ è·å–å¯ç”¨å‘½ä»¤
  â””â”€ è¿”å› { sessionId, models, modes }

T3:
  Zed ç”¨æˆ·: "åœ¨ src/main.ts ä¸­æ·»åŠ  TypeScript ç±»å‹"
  Zed å‘é€: prompt(text)
  acp-agent: prompt()
  â”œâ”€ promptToClaude() è½¬æ¢
  â”œâ”€ input.push(userMessage)
  â””â”€ å¯åŠ¨ query.next() å¾ªç¯

T4-5:
  SDK å¤„ç†è¯·æ±‚:
  â”œâ”€ è°ƒç”¨ Claude API
  â”œâ”€ Claude: "æˆ‘éœ€è¦è¯»å– src/main.ts"
  â””â”€ è¿”å› tool_use å—

T6:
  acp-agent æ”¶åˆ° tool_use:
  â”œâ”€ toolUseCache[id] = toolUse
  â”œâ”€ toolInfoFromToolUse() è½¬æ¢
  â””â”€ sessionUpdate("tool_call", "Read src/main.ts")

  Zed æ˜¾ç¤º:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ğŸ“– Read src/main.ts â”‚
  â”‚ [Show] [Approve]  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T7:
  Zed ç”¨æˆ·ç‚¹å‡» [Approve]
  acp-agent (é€šè¿‡æƒé™ HTTP æœåŠ¡):
  â”œâ”€ æ£€æŸ¥æƒé™æ¨¡å¼
  â”œâ”€ allowDangerouslySkipPermissions: false
  â”‚  â””â”€ æƒé™æ¨¡å¼: "default" â†’ éœ€è¦ç”¨æˆ·æ‰¹å‡†
  â””â”€ è¿”å› PermissionResult { approved: true }

T8:
  SDK ç»§ç»­æ‰§è¡Œå·¥å…·:
  â”œâ”€ MCP å·¥å…·å¤„ç†å™¨: registerTool("Read")
  â”œâ”€ è°ƒç”¨ agent.readTextFile()
  â”œâ”€ è¿”å›æ–‡ä»¶å†…å®¹ç»™ SDK
  â””â”€ SDK ç”Ÿæˆ tool_result

T9:
  acp-agent æ”¶åˆ° tool_result:
  â”œâ”€ toolUseCache[id] æŸ¥è¯¢
  â”œâ”€ toolUpdateFromToolResult() è½¬æ¢
  â””â”€ sessionUpdate("tool_call_update", "completed")

  Zed æ˜¾ç¤ºæ–‡ä»¶å†…å®¹åœ¨å·¥å…·è°ƒç”¨ä¸‹

T10:
  SDK ç»§ç»­è¿­ä»£:
  â”œâ”€ Claude: "ç°åœ¨æˆ‘æ¥æ·»åŠ ç±»å‹..."
  â”œâ”€ è¿”å› stream_event å—æµ
  â”œâ”€ content_block_delta: "export"
  â”œâ”€ content_block_delta: " interface"
  â”œâ”€ content_block_delta: " User { ... }"
  â””â”€ message_stop

T11:
  acp-agent å¤„ç†æµ:
  â”œâ”€ streamEventToAcpNotifications()
  â”œâ”€ sessionUpdate("agent_message_chunk", "export")
  â”œâ”€ sessionUpdate("agent_message_chunk", " interface")
  â”œâ”€ sessionUpdate("agent_message_chunk", " User { ... }")
  â”‚
  â””â”€ Zed å®æ—¶æ˜¾ç¤º:
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ export interface User {  â”‚
     â”‚   ...                    â”‚ â† æ­£åœ¨æµå…¥
     â”‚ }                        â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T12:
  Claude å†³å®šç¼–è¾‘æ–‡ä»¶:
  â”œâ”€ tool_use: Edit
  â”‚  â”œâ”€ file_path: "src/main.ts"
  â”‚  â”œâ”€ old_string: "// Add types here"
  â”‚  â””â”€ new_string: "export interface User { ... }"
  â”‚
  â””â”€ sessionUpdate("tool_call", "Edit src/main.ts")

     Zed æ˜¾ç¤º:
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ âœï¸  Edit `src/main.ts`   â”‚
     â”‚                          â”‚
     â”‚ - // Add types here      â”‚
     â”‚ + export interface User  â”‚
     â”‚ +  { ... }               â”‚
     â”‚                          â”‚
     â”‚ [Review] [Approve]       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T13:
  Zed ç”¨æˆ·ç‚¹å‡» [Approve]
  acp-agent:
  â”œâ”€ æƒé™ç³»ç»Ÿæ£€æŸ¥
  â”œâ”€ permissionMode: "default"
  â”‚  â”œâ”€ å·¥å…·: Edit
  â”‚  â””â”€ éœ€è¦æ‰¹å‡†
  â”œâ”€ è¿”å›æ‰¹å‡†ç»“æœç»™ SDK
  â””â”€ SDK ç»§ç»­å·¥å…·æ‰§è¡Œ

T14:
  MCP Edit å·¥å…·å¤„ç†:
  â”œâ”€ è¯»å–æ–‡ä»¶: readTextFile(...)
  â”œâ”€ æ‰§è¡Œæ›¿æ¢: replaceAndCalculateLocation(...)
  â”‚  â”œâ”€ éªŒè¯ old_string å­˜åœ¨
  â”‚  â”œâ”€ æ›¿æ¢æ–‡æœ¬
  â”‚  â””â”€ è¿”å› { newContent, lineNumbers: [5, 6, 7] }
  â”œâ”€ ç”Ÿæˆ patch (diff)
  â”œâ”€ å†™å…¥æ–‡ä»¶: writeTextFile(...)
  â”œâ”€ æ›´æ–°ç¼“å­˜: fileContentCache["src/main.ts"] = newContent
  â””â”€ è¿”å› patch ç»™ SDK

T15:
  acp-agent æ”¶åˆ° tool_result:
  â”œâ”€ sessionUpdate("tool_call_update", {
  â”‚    status: "completed",
  â”‚    content: [{
  â”‚      type: "diff",
  â”‚      path: "src/main.ts",
  â”‚      oldText: "...",
  â”‚      newText: "..."
  â”‚    }]
  â”‚  })
  â”‚
  â””â”€ Zed æ˜¾ç¤ºç¼–è¾‘çš„ diff

T16:
  SDK ç»§ç»­è¿­ä»£:
  â”œâ”€ Claude: "å®Œæˆï¼æˆ‘å·²æ·»åŠ ..."
  â”œâ”€ è¿”å›æœ€åæ¶ˆæ¯
  â””â”€ è¿”å› result { success: "..." }

T17:
  acp-agent æ”¶åˆ° result:
  â”œâ”€ sessionUpdate("agent_message_chunk", "å®Œæˆï¼...")
  â”œâ”€ è¿”å› prompt() response { stopReason: "end_turn" }
  â””â”€ å¯¹è¯ç»“æŸ

T18:
  Zed è¡¨ç°ä¸º:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ å®Œæˆï¼æˆ‘å·²æ·»åŠ  User æ¥å£...  â”‚
  â”‚                              â”‚
  â”‚ âœ“ ç¼–è¾‘å·²åº”ç”¨                 â”‚
  â”‚                              â”‚
  â”‚ [Continue] [End Conversation]â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T19 (å¯é€‰):
  Zed ç”¨æˆ·ç‚¹å‡» [Continue]
  â””â”€ å‘é€æ–° prompt()
     â””â”€ å›åˆ° T4...

ç»“æŸ:
  Zed å…³é—­è¿æ¥
  acp-agent:
  â”œâ”€ æ¸…ç† sessions[sessionId]
  â”œâ”€ å…³é—­ MCP æœåŠ¡å™¨
  â”œâ”€ å…³é—­æƒé™ HTTP æœåŠ¡å™¨
  â””â”€ è¿›ç¨‹é€€å‡º
```

---

## å…³é”®æ•°æ®æµåŒæ­¥ç‚¹

```
å¹¶å‘å®‰å…¨è€ƒè™‘:

toolUseCache
â”œâ”€ å†™å…¥: toAcpNotifications() æ”¶åˆ° tool_use
â”œâ”€ è¯»å–: æ”¶åˆ° tool_result æ—¶æŸ¥è¯¢
â””â”€ å¯èƒ½ç«äº‰: tool_use å’Œ tool_result é¡ºåºä¿è¯

fileContentCache
â”œâ”€ å†™å…¥: readTextFile()ã€writeTextFile()ã€Edit å·¥å…·
â”œâ”€ è¯»å–: ç¼–è¾‘æ—¶éœ€è¦åŸå§‹å†…å®¹
â””â”€ ä¸€è‡´æ€§: SDK å•çº¿ç¨‹ (Query è¿­ä»£)

backgroundTerminals
â”œâ”€ å†™å…¥: Bash å·¥å…·åˆ›å»ºã€çŠ¶æ€è½¬æ¢
â”œâ”€ è¯»å–: BashOutputã€KillShell æŸ¥è¯¢
â””â”€ ç«äº‰: å¤šä¸ªåå°è¿›ç¨‹å¯èƒ½å¹¶å‘

sessions
â”œâ”€ å†™å…¥: newSession()
â”œâ”€ è¯»å–: prompt()ã€cancel()ã€setSessionMode()
â””â”€ éš”ç¦»: sessionId æä¾›å®Œæ•´éš”ç¦»

SDK Query
â”œâ”€ ä¿è¯: å•ä¸ª Query å¯¹è±¡ = å•ä¸ªä¼šè¯
â”œâ”€ è¿­ä»£: while (true) { await query.next() }
â””â”€ çº¿ç¨‹å®‰å…¨: SDK å†…éƒ¨å¤„ç†
```

è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªæ°å‡ºçš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä¼˜é›…åœ°å¤„ç†å¤æ‚çš„åè®®é€‚é…å’ŒçŠ¶æ€ç®¡ç†é—®é¢˜ï¼
